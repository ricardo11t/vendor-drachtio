name: Deploy Vendor Drachtio

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite deploy manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deploy_production
    
    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4
      
      - name: Validar estrutura do projeto
        run: |
          echo "üìã Validando estrutura do projeto..."
          test -f docker-compose.yml || (echo "‚ùå docker-compose.yml n√£o encontrado!" && exit 1)
          test -f package.json || (echo "‚ö†Ô∏è Aviso: package.json n√£o encontrado" && true)
          echo "‚úÖ Estrutura validada"
      
      - name: Deploy no EC2 via SSH
        uses: appleboy/ssh-action@v1.6.1
        with:
          host: ${{secrets.EC2_HOST}}
          username: ${{secrets.EC2_USERNAME}}
          key: ${{secrets.EC2_SSH_KEY}}
          port: 22
          script: |
            set -e  # Exit on error
            
            echo "üöÄ Iniciando deploy do Vendor Drachtio..."
            
            # Verificar conectividade
            if ! ping -c 1 8.8.8.8 &> /dev/null; then
              echo "‚ùå Sem conex√£o de internet"
              exit 1
            fi
            
            cd ~/vendor-drachtio/ || (echo "‚ùå Diret√≥rio ~/vendor-drachtio/ n√£o encontrado" && exit 1)
            
            # Pull do c√≥digo
            echo "üì• Fazendo pull do c√≥digo..."
            git pull origin main || (echo "‚ùå Erro ao fazer pull" && exit 1)
            
            # Verificar estrutura
            test -f docker-compose.yml || (echo "‚ùå docker-compose.yml n√£o encontrado ap√≥s pull!" && exit 1)
            
            # Build e start
            echo "üê≥ Construindo e iniciando containers..."
            docker-compose down || true
            docker-compose up -d --build || (echo "‚ùå Erro ao iniciar containers" && exit 1)
            
            # Aguardar health check
            echo "‚è≥ Aguardando containers ficarem saud√°veis..."
            sleep 10
            
            # Verificar se Drachtio est√° respondendo
            if docker exec vendor-drachtio pgrep -f "drachtio-server" > /dev/null 2>&1; then
              echo "‚úÖ Drachtio est√° rodando"
            else
              echo "‚ö†Ô∏è Aviso: Drachtio pode n√£o estar totalmente inicializado"
            fi
            
            # Limpeza
            echo "üßπ Limpando imagens n√£o utilizadas..."
            docker image prune -f --filter "dangling=true"
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
      
      - name: Notificar sucesso
        if: success()
        run: echo "üéâ Deploy bem-sucedido em $(date)"
      
      - name: Notificar falha
        if: failure()
        run: |
          echo "‚ùå Deploy FALHOU"
          echo "Verifique os logs do GitHub Actions para detalhes"
          exit 1

