name: Deploy Vendor Drachtio

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite deploy manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deploy_production
    
    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4
      
      - name: Validar secrets configurados
        run: |
          echo "ğŸ” Validando configuraÃ§Ã£o de secrets..."
          
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "âŒ EC2_HOST nÃ£o estÃ¡ configurado"
            echo "Adicione em: Settings > Environments > deploy_production > Secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.EC2_USERNAME }}" ]; then
            echo "âŒ EC2_USERNAME nÃ£o estÃ¡ configurado"
            exit 1
          fi
          
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "âŒ EC2_SSH_KEY nÃ£o estÃ¡ configurado"
            exit 1
          fi
          
          echo "âœ… Todos os secrets estÃ£o configurados"
          echo "Host: ${{ secrets.EC2_HOST }}"
          echo "Username: ${{ secrets.EC2_USERNAME }}"
      
      - name: Validar estrutura do projeto
        run: |
          echo "ğŸ“‹ Validando estrutura do projeto..."
          test -f docker-compose.yml || (echo "âŒ docker-compose.yml nÃ£o encontrado!" && exit 1)
          echo "âœ… Estrutura validada"
      
      - name: Deploy no EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30s
          debug: true
          script: |
            set -e  # Exit on error
            
            echo "ğŸš€ Iniciando deploy do Vendor Drachtio..."
            echo "ğŸ• $(date)"
            
            # Verificar se estamos no diretÃ³rio certo
            pwd
            ls -la
            
            # Navegar para o diretÃ³rio do projeto
            if [ -d "$HOME/vendor-drachtio" ]; then
              cd "$HOME/vendor-drachtio/"
            elif [ -d "$HOME/projects/vendor-drachtio" ]; then
              cd "$HOME/projects/vendor-drachtio/"
            elif [ -d "/opt/vendor-drachtio" ]; then
              cd "/opt/vendor-drachtio/"
            else
              echo "âŒ Nenhum diretÃ³rio vendor-drachtio encontrado"
              find $HOME -type d -name "vendor-drachtio" 2>/dev/null || echo "Nenhum diretÃ³rio encontrado"
              exit 1
            fi
            
            echo "ğŸ“‚ DiretÃ³rio atual: $(pwd)"
            
            # Verificar se git estÃ¡ disponÃ­vel
            if ! command -v git &> /dev/null; then
              echo "âŒ Git nÃ£o estÃ¡ instalado"
              exit 1
            fi
            
            # Pull do cÃ³digo
            echo "ğŸ“¥ Fazendo pull do cÃ³digo..."
            git pull origin main || (echo "âŒ Erro ao fazer pull" && exit 1)
            
            # Verificar estrutura
            test -f docker-compose.yml || (echo "âŒ docker-compose.yml nÃ£o encontrado!" && exit 1)
            echo "âœ… docker-compose.yml encontrado"
            
            # Verificar se Docker estÃ¡ disponÃ­vel
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker nÃ£o estÃ¡ instalado"
              exit 1
            fi
            
            # Build e start
            echo "ğŸ³ Construindo e iniciando containers..."
            docker-compose down || true
            docker-compose up -d --build
            
            # Aguardar health check
            echo "â³ Aguardando containers ficarem saudÃ¡veis..."
            sleep 15
            
            # Verificar status dos containers
            echo "ğŸ“Š Status dos containers:"
            docker-compose ps
            
            # Limpeza
            echo "ğŸ§¹ Limpando imagens nÃ£o utilizadas..."
            docker image prune -f --filter "dangling=true"
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸ• $(date)"
      
      - name: Notificar sucesso
        if: success()
        run: echo "ğŸ‰ Deploy bem-sucedido!"
      
      - name: Notificar falha
        if: failure()
        run: |
          echo "âŒ Deploy FALHOU"
          echo "Verifique os logs do GitHub Actions para detalhes"
          exit 1


