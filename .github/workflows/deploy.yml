name: Deploy Vendor Drachtio

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deploy_production
    
    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4
      
      - name: Deploy no EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30s
          debug: true
          script: |
            set -e  # Exit on error
            
            echo "Iniciando deploy do Vendor Drachtio..."
            echo "$(date)"
            
            # Verificar se estamos no diretório certo
            pwd
            ls -la
            
            # Navegar para o diretório do projeto
            if [ -d "$HOME/vendor-drachtio" ]; then
              cd "$HOME/vendor-drachtio/"
            elif [ -d "$HOME/projects/vendor-drachtio" ]; then
              cd "$HOME/projects/vendor-drachtio/"
            elif [ -d "/opt/vendor-drachtio" ]; then
              cd "/opt/vendor-drachtio/"
            else
              echo "Nenhum diretório vendor-drachtio encontrado"
              find $HOME -type d -name "vendor-drachtio" 2>/dev/null || echo "Nenhum diretório encontrado"
              exit 1
            fi
            
            echo "Diretório atual: $(pwd)"

            if ! command -v git &> /dev/null; then
              echo "Git não está instalado"
              exit 1
            fi

            echo "Fazendo pull do código..."
            git pull origin main || (echo "Erro ao fazer pull" && exit 1)
            
            test -f docker-compose.yml || (echo "docker-compose.yml não encontrado!" && exit 1)
            echo "docker-compose.yml encontrado"
            
            # Verificar se Docker está disponível
            if ! command -v docker &> /dev/null; then
              echo "Docker não está instalado"
              exit 1
            fi
            
            docker-compose down || true
            docker-compose up -d --build

            sleep 15

            echo "Status dos containers Docker:"
            docker-compose ps
            
            # Limpeza
            echo "Limpando imagens não utilizadas..."
            docker image prune -f --filter "dangling=true"
            
            echo "Deploy concluído com sucesso!"
            echo "$(date)"
      
      - name: Notificar sucesso
        if: success()
        run: echo "Deploy bem-sucedido!"
      
      - name: Notificar falha
        if: failure()
        run: |
          echo "Deploy FALHOU"
          echo "Verifique os logs do GitHub Actions para detalhes"
          exit 1


