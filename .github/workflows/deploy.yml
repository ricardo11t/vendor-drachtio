name: Deploy Vendor Drachtio

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deploy_production
    
    steps:
      - name: Checkout do codigo
        uses: actions/checkout@v4
      
      - name: Deploy no EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 180s
          command_timeout: 180s
          debug: true
          script: |
            set -e  # Exit on error
            
            echo "Iniciando deploy do Vendor Drachtio..."
            echo "$(date)"
            
            # ======================================================================
            # LIMPEZA PREVENTIVA DE DISCO (ANTES DE FAZER PULL)
            # ======================================================================
            echo ""
            echo "üßπ Verificando espa√ßo em disco..."
            df -h | grep -E "^/dev/|Mounted"
            
            DISK_USAGE=$(df / | awk 'NR==2 {print int($5)}')
            echo "Uso de disco: ${DISK_USAGE}%"
            
            if [ ${DISK_USAGE} -gt 85 ]; then
              echo "‚ö†Ô∏è  Disco acima de 85%. Executando limpeza agressiva..."
              
              # Parar todos os containers primeiro
              docker-compose down 2>/dev/null || docker stop $(docker ps -q) 2>/dev/null || true
              
              # 1. Remover containers parados
              echo "Removendo containers parados..."
              docker container prune -f
              
              # 2. Remover imagens dangling
              echo "Removendo imagens dangling..."
              docker image prune -f --filter "dangling=true"
              
              # 3. Remover imagens n√£o utilizadas
              echo "Removendo imagens n√£o utilizadas..."
              docker image prune -f --all --filter "until=72h"
              
              # 4. Remover volumes √≥rf√£os
              echo "Removendo volumes √≥rf√£os..."
              docker volume prune -f
              
              # 5. Limpar build cache (CUIDADO: vai for√ßar rebuild)
              echo "Limpando build cache..."
              docker builder prune -f --all
              
              # 6. Limpar npm cache se existir
              if [ -d "node_modules" ]; then
                echo "Removendo node_modules (vai reinstalar)..."
                rm -rf node_modules package-lock.json
              fi
              
              # Verificar resultado
              DISK_USAGE_AFTER=$(df / | awk 'NR==2 {print int($5)}')
              echo "‚úÖ Ap√≥s limpeza: ${DISK_USAGE_AFTER}%"
              
              if [ ${DISK_USAGE_AFTER} -gt 90 ]; then
                echo "‚ùå ERRO: Disco ainda acima de 90% ap√≥s limpeza!"
                echo "Poss√≠vel solu√ß√£o: aumentar tamanho do volume EBS ou remover dados antigos"
                exit 1
              fi
            fi
            
            # ======================================================================
            # DEPLOY NORMAL
            # ======================================================================
            
            # Verificar se estamos no diret√≥rio certo
            pwd
            ls -la
            
            # Navegar para o diret√≥rio do projeto
            if [ -d "$HOME/vendor-drachtio" ]; then
              cd "$HOME/vendor-drachtio/"
            elif [ -d "$HOME/projects/vendor-drachtio" ]; then
              cd "$HOME/projects/vendor-drachtio/"
            elif [ -d "/opt/vendor-drachtio" ]; then
              cd "/opt/vendor-drachtio/"
            else
              echo "Nenhum diret√≥rio vendor-drachtio encontrado"
              find $HOME -type d -name "vendor-drachtio" 2>/dev/null || echo "Nenhum diret√≥rio encontrado"
              exit 1
            fi
            
            echo "Diret√≥rio atual: $(pwd)"

            if ! command -v git &> /dev/null; then
              echo "Git n√£o est√° instalado"
              exit 1
            fi

            echo "Fazendo pull do c√≥digo..."
            git pull origin main || (echo "Erro ao fazer pull" && exit 1)
            
            test -f docker-compose.yml || (echo "docker-compose.yml n√£o encontrado!" && exit 1)
            echo "docker-compose.yml encontrado"
            
            # Verificar se Docker est√° dispon√≠vel
            if ! command -v docker &> /dev/null; then
              echo "Docker n√£o est√° instalado"
              exit 1
            fi
            
            echo "Parando containers antigos..."
            docker-compose down || true

            echo "Removendo build cache do docker-compose..."
            docker system prune -f --all || true

            echo "Buildando e iniciando com docker-compose (for√ßa rebuild)..."
            docker-compose up -d --build --force-recreate

            echo "Status dos containers Docker:"
            docker-compose ps
            
            # Limpeza final (remover dangling images)
            echo "Limpando imagens dangling..."
            docker image prune -f --filter "dangling=true" || true
            
            echo ""
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            echo "$(date)"
            echo ""
            df -h | grep -E "^/dev/|Mounted"
      
      - name: Notificar sucesso
        if: success()
        run: echo "Deploy bem-sucedido!"
      
      - name: Notificar falha
        if: failure()
        run: |
          echo "Deploy FALHOU"
          echo "Verifique os logs do GitHub Actions para detalhes"
          exit 1


