version: '3.8'

services:
  # --- SIP Services ---
  drachtio:
    image: drachtio/drachtio-server:latest
    container_name: drachtio-server
    restart: always
    # MUDANÇA CRUCIAL: Rede do Host (VPS) direta
    network_mode: "host"
    # CORREÇÃO: --contact especifica porta SIP (5060), --port especifica porta aplicação (9022)
    command: drachtio --contact "sip:*:5060;transport=udp,tcp" --port 9022 --secret cymru
    environment:
      DRACHTIO_SECRET: cymru

  redis:
    image: redis:7-alpine
    container_name: drachtio-redis
    restart: always
    # Redis também no host para o app achar via 127.0.0.1
    network_mode: "host"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  rtpengine:
    image: drachtio/rtpengine:latest
    container_name: rtpengine
    restart: always
    network_mode: "host"
    privileged: true
    command: >
      rtpengine --interface=public/172.31.2.132!56.125.223.86
      --listen-ng=127.0.0.1:22222
      --pidfile=/var/run/rtpengine.pid
      --port-min=20000 --port-max=30000
      --recording-method=none
      --log-level=7
      --foreground

  sip-controller:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: drachtio-controller
    restart: always
    network_mode: "host"
    environment:
      NODE_ENV: production
      LOGLEVEL: info
      
      DRACHTIO_HOST: 127.0.0.1
      DRACHTIO_PORT: 9022
      DRACHTIO_SECRET: cymru
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      
      PUBLIC_IP: ${PUBLIC_IP}
      BACKEND_URL: ${BACKEND_URL}
      VENDOR_API_KEY: ${VENDOR_API_KEY}
      
    depends_on:
      drachtio:
        condition: service_started
      redis:
        condition: service_healthy
      rtpengine:
        condition: service_started
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
